<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTK Coin Miner - Complete</title>
    <style>
        :root {
            --primary: #f8c555;
            --primary-dark: #e6b142;
            --secondary: #667eea;
            --secondary-dark: #5a67d8;
            --success: #2ed573;
            --error: #ff4757;
            --warning: #ffa502;
            --info: #1e90ff;
            --dark-bg: #1a1a2e;
            --darker-bg: #16213e;
            --light-text: #ffffff;
            --gray-text: #a0aec0;
            --card-bg: rgba(0, 0, 0, 0.7);
            --glass-effect: backdrop-filter: blur(10px);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
            --border-radius: 15px;
            --border-radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--light-text);
            line-height: 1.5;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 1024px) {
            .container {
                flex-direction: row;
            }
            .game-column { flex: 2; }
            .wallet-column { flex: 1; min-width: 350px; }
        }

        .section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            margin: 10px 0 20px;
            color: var(--primary);
            font-size: clamp(1.8rem, 5vw, 2.5rem);
        }

        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: clamp(1.3rem, 4vw, 1.8rem);
        }

        .game-container {
            background: var(--darker-bg);
            border: 3px solid var(--primary);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            margin-bottom: 20px;
            aspect-ratio: 16/9;
            max-height: 60vh;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: var(--dark-bg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        @media (min-width: 640px) {
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .stat-card {
            background: rgba(248, 197, 85, 0.15);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-text);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #000;
            border: none;
            padding: 12px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(248, 197, 85, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success { background: linear-gradient(135deg, var(--success), #25c164); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #e59400); }
        .btn-danger { background: linear-gradient(135deg, var(--error), #e84151); }
        .btn-info { background: linear-gradient(135deg, var(--info), #187bcd); }

        .wallet-card {
            background: rgba(248, 197, 85, 0.1);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-sm);
        }

        .label {
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
        }

        .value {
            color: var(--light-text);
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .value.highlight { color: var(--success); }

        .token-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        input {
            padding: 12px;
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--primary);
            background: rgba(255, 255, 255, 0.05);
            color: var(--light-text);
            font-size: 16px;
        }

        .gas-info {
            background: rgba(255, 159, 67, 0.1);
            border: 2px solid var(--warning);
            border-radius: var(--border-radius-sm);
            padding: 10px;
            font-size: 14px;
            margin: 10px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--primary);
            color: #000;
            border-radius: var(--border-radius-sm);
            font-weight: bold;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .pending-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
            text-align: center;
            padding: 20px;
        }

        .pending-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(248, 197, 85, 0.3);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .connection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding: 20px;
        }

        .big-connect-btn {
            padding: 20px 40px;
            font-size: 20px;
            margin: 20px 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--border-radius-sm);
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .mine-spot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="pendingOverlay" class="pending-overlay hidden">
        <div class="pending-spinner"></div>
        <div class="pending-text" id="pendingText">Processing Transaction...</div>
        <div class="tx-hash" id="pendingTxHash"></div>
        <div class="gas-info" id="pendingGasInfo"></div>
        <button class="btn btn-danger" onclick="hidePendingOverlay()" style="margin-top: 20px;">
            Cancel
        </button>
    </div>
    
    <div id="connectionScreen" class="connection-screen">
        <h1>üöÄ MTK Coin Miner</h1>
        <p style="color: var(--gray-text); margin-bottom: 20px;">
            Mine, Claim & Withdraw MTK Tokens
        </p>
        <button class="big-connect-btn" onclick="connectWallet()">
            üîó Connect MetaMask
        </button>
    </div>
    
    <div id="gameScreen" class="hidden">
        <h1>‚õèÔ∏è MTK Coin Miner</h1>
        
        <div class="container">
            <div class="game-column">
                <div class="section">
                    <h2>üéÆ Mining Game</h2>
                    <div class="game-container">
                        <canvas id="gameCanvas"></canvas>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">MTK Mined</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="multiplier">1x</div>
                            <div class="stat-label">Mining Power</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="miners">1</div>
                            <div class="stat-label">Active Miners</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="speed">1.0</div>
                            <div class="stat-label">Mining Speed</div>
                        </div>
                    </div>
                    
                    <div class="controls-grid">
                        <button onclick="upgradeMiningPower()" class="btn">
                            ‚¨ÜÔ∏è Upgrade Power
                        </button>
                        <button onclick="buyMiner()" class="btn">
                            üë∑ Buy Miner
                        </button>
                        <button onclick="upgradeSpeed()" class="btn">
                            ‚ö° Increase Speed
                        </button>
                        <button onclick="claimTokens()" class="btn btn-success">
                            üí∞ Claim MTK
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="wallet-column">
                <div class="section">
                    <h2>üëõ Wallet & Transactions</h2>
                    
                    <div class="wallet-card">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Status</span>
                                <span class="value highlight" id="walletStatus">Connected</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Account</span>
                                <span class="value" id="accountAddress">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Network</span>
                                <span class="value" id="network">Sepolia</span>
                            </div>
                            <div class="info-item">
                                <span class="label">ETH Balance</span>
                                <span class="value" id="ethBalance">0 ETH</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="token-actions">
                        <!-- Claim Section -->
                        <div class="wallet-card" style="background: rgba(46, 213, 115, 0.1); border-color: var(--success);">
                            <h3 style="color: var(--success); margin-bottom: 15px;">üí∞ Claim Tokens</h3>
                            <div class="info-item">
                                <span class="label">Game Balance</span>
                                <span class="value" id="gameBalance">0 MTK</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Claimable</span>
                                <span class="value highlight" id="claimableAmount">0 MTK</span>
                            </div>
                            <button onclick="estimateClaimGas()" id="claimBtn" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                                üí∞ Claim MTK Tokens
                            </button>
                            <div class="gas-info" id="claimGasInfo">
                                Click to estimate gas for claiming
                            </div>
                        </div>
                        
                        <!-- Withdraw Section -->
                        <div class="wallet-card" style="background: rgba(255, 159, 67, 0.1); border-color: var(--warning);">
                            <h3 style="color: var(--warning); margin-bottom: 15px;">üè¶ Withdraw Tokens</h3>
                            <div class="info-item">
                                <span class="label">Wallet Balance</span>
                                <span class="value" id="walletBalance">0 MTK</span>
                            </div>
                            <div class="input-group">
                                <label style="color: var(--warning); font-weight: 600;">Withdraw Amount (MTK)</label>
                                <input type="number" id="withdrawAmount" placeholder="Enter amount" min="1" value="100">
                            </div>
                            <div class="input-group">
                                <label style="color: var(--warning); font-weight: 600;">Recipient Address</label>
                                <input type="text" id="recipientAddress" placeholder="0x..." value="">
                            </div>
                            <button onclick="estimateWithdrawGas()" id="withdrawBtn" class="btn btn-warning" style="width: 100%; margin-top: 10px;">
                                üè¶ Withdraw MTK
                            </button>
                            <div class="gas-info" id="withdrawGasInfo">
                                Enter amount to estimate gas
                            </div>
                        </div>
                        
                        <!-- Token Balances -->
                        <div class="wallet-card">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üìä Token Balances</h3>
                            <div class="info-item">
                                <span class="label">Total Mined</span>
                                <span class="value" id="totalMined">0 MTK</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Total Claimed</span>
                                <span class="value" id="totalClaimed">0 MTK</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Total Withdrawn</span>
                                <span class="value" id="totalWithdrawn">0 MTK</span>
                            </div>
                            <button onclick="refreshBalances()" class="btn btn-info" style="width: 100%; margin-top: 10px;">
                                üîÑ Refresh Balances
                            </button>
                        </div>
                        
                        <button onclick="disconnectWallet()" class="btn btn-danger" style="width: 100%;">
                            üîì Disconnect Wallet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // ====================
        // GAME VARIABLES
        // ====================
        let score = 0;
        let miningPower = 1;
        let miners = 1;
        let miningSpeed = 1.0;
        let gameInterval;
        let mineSpots = [];
        
        // Token tracking
        let totalMined = 0;
        let totalClaimed = 0;
        let totalWithdrawn = 0;
        let walletBalance = 0; // MTK tokens in wallet
        let claimableBalance = 0; // MTK available to claim
        
        // ====================
        // BLOCKCHAIN VARIABLES
        // ====================
        let web3;
        let userAccount;
        let mtkContract;
        let connected = false;
        
        // Contract Configuration
        const MTK_CONTRACT_ADDRESS = '0x3e622317f8C93f7328350cF0B56d9eD4C620C5d6'; // DAI on Sepolia for testing
        const MTK_CONTRACT_ABI = [
            // ERC20 Standard Functions
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"name": "", "type": "uint256"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "_to", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "transfer",
                "outputs": [{"name": "success", "type": "bool"}],
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "from", "type": "address"},
                    {"indexed": true, "name": "to", "type": "address"},
                    {"indexed": false, "name": "value", "type": "uint256"}
                ],
                "name": "Transfer",
                "type": "event"
            }
        ];

        // ====================
        // GAME FUNCTIONS
        // ====================
        function initGame() {
            const canvas = document.getElementById('gameCanvas');
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            createMineSpots(canvas);
            gameInterval = setInterval(() => updateGame(canvas), 1000 / miningSpeed);
            updateUI();
        }

        function createMineSpots(canvas) {
            mineSpots = [];
            const spotCount = 5;
            for (let i = 0; i < spotCount; i++) {
                mineSpots.push({
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: Math.random() * (canvas.height - 40) + 20,
                    active: true
                });
            }
        }

        function updateGame(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw mine spots
            mineSpots.forEach(spot => {
                if (spot.active) {
                    ctx.fillStyle = '#f8c555';
                    ctx.beginPath();
                    ctx.arc(spot.x, spot.y, 10, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Auto mining
            mineSpots.forEach(spot => {
                if (spot.active && Math.random() < 0.3) {
                    const mined = miningPower * miners;
                    score += mined;
                    totalMined += mined;
                    claimableBalance += mined;
                    updateUI();
                }
            });
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            mineSpots.forEach(spot => {
                const distance = Math.sqrt((x - spot.x) ** 2 + (y - spot.y) ** 2);
                if (distance < 20 && spot.active) {
                    const minedAmount = miningPower * 10;
                    score += minedAmount;
                    totalMined += minedAmount;
                    claimableBalance += minedAmount;
                    spot.active = false;
                    
                    setTimeout(() => {
                        spot.active = true;
                        spot.x = Math.random() * (canvas.width - 40) + 20;
                        spot.y = Math.random() * (canvas.height - 40) + 20;
                    }, 1000);
                    
                    updateUI();
                    showNotification(`+${minedAmount} MTK mined!`, 'success');
                }
            });
        });

        function upgradeMiningPower() {
            if (score >= 100) {
                score -= 100;
                miningPower++;
                updateUI();
                showNotification('Mining power upgraded!', 'success');
            } else {
                showNotification('Not enough MTK!', 'error');
            }
        }

        function buyMiner() {
            if (score >= 500) {
                score -= 500;
                miners++;
                updateUI();
                showNotification('New miner purchased!', 'success');
            } else {
                showNotification('Not enough MTK!', 'error');
            }
        }

        function upgradeSpeed() {
            if (score >= 250) {
                score -= 250;
                miningSpeed += 0.5;
                clearInterval(gameInterval);
                gameInterval = setInterval(() => updateGame(document.getElementById('gameCanvas')), 1000 / miningSpeed);
                updateUI();
                showNotification('Mining speed increased!', 'success');
            } else {
                showNotification('Not enough MTK!', 'error');
            }
        }

        // ====================
        // CLAIMING FUNCTIONS
        // ====================
        async function estimateClaimGas() {
            if (claimableBalance <= 0) {
                showNotification('No tokens available to claim!', 'error');
                return;
            }
            
            try {
                const claimBtn = document.getElementById('claimBtn');
                claimBtn.disabled = true;
                claimBtn.textContent = '‚è≥ Estimating Gas...';
                
                // Estimate gas for claim transaction
                const estimatedGas = 65000; // Approximate for token minting
                const gasPrice = await web3.eth.getGasPrice();
                const gasCost = web3.utils.fromWei((BigInt(estimatedGas) * BigInt(gasPrice)).toString(), 'ether');
                
                document.getElementById('claimGasInfo').innerHTML = `
                    Estimated Gas: ${estimatedGas.toLocaleString()} units<br>
                    Gas Price: ${web3.utils.fromWei(gasPrice, 'gwei')} Gwei<br>
                    Estimated Cost: ~${parseFloat(gasCost).toFixed(6)} ETH
                `;
                
                claimBtn.disabled = false;
                claimBtn.textContent = `üí∞ Claim ${claimableBalance} MTK`;
                claimBtn.onclick = () => claimTokens();
                
                showNotification('Gas estimation complete!', 'success');
                
            } catch (error) {
                showNotification('Gas estimation failed: ' + error.message, 'error');
                document.getElementById('claimBtn').disabled = false;
                document.getElementById('claimBtn').textContent = 'üí∞ Claim MTK Tokens';
            }
        }

        async function claimTokens() {
            if (claimableBalance <= 0) {
                showNotification('No tokens to claim!', 'error');
                return;
            }
            
            try {
                showPendingOverlay('Claiming MTK tokens...');
                
                // In a real implementation, this would call a smart contract function
                // For demo purposes, we simulate the transaction
                
                const txHash = '0x' + Array.from({length: 64}, () => 
                    Math.floor(Math.random() * 16).toString(16)).join('');
                
                document.getElementById('pendingTxHash').textContent = `Tx Hash: ${txHash.substring(0, 20)}...`;
                
                // Simulate blockchain delay
                setTimeout(async () => {
                    // Update balances
                    const claimedAmount = claimableBalance;
                    walletBalance += claimedAmount;
                    totalClaimed += claimedAmount;
                    claimableBalance = 0;
                    score = 0; // Reset game score after claiming
                    
                    updateUI();
                    hidePendingOverlay();
                    
                    showNotification(`‚úÖ Successfully claimed ${claimedAmount} MTK!`, 'success');
                    
                    // Reset claim button
                    const claimBtn = document.getElementById('claimBtn');
                    claimBtn.textContent = 'üí∞ Claim MTK Tokens';
                    claimBtn.onclick = () => estimateClaimGas();
                    
                    // Update gas info
                    document.getElementById('claimGasInfo').innerHTML = `
                        ‚úÖ Claim successful!<br>
                        ${claimedAmount} MTK added to your wallet
                    `;
                    
                }, 3000);
                
            } catch (error) {
                hidePendingOverlay();
                showNotification('Claim failed: ' + error.message, 'error');
                
                const claimBtn = document.getElementById('claimBtn');
                claimBtn.textContent = 'üí∞ Claim MTK Tokens';
                claimBtn.onclick = () => estimateClaimGas();
            }
        }

        // ====================
        // WITHDRAWAL FUNCTIONS
        // ====================
        async function estimateWithdrawGas() {
            const amountInput = document.getElementById('withdrawAmount');
            const amount = parseFloat(amountInput.value);
            const recipient = document.getElementById('recipientAddress').value;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (!recipient || !recipient.startsWith('0x')) {
                showNotification('Please enter a valid recipient address', 'error');
                return;
            }
            
            if (walletBalance < amount) {
                showNotification(`Insufficient balance! You have ${walletBalance} MTK`, 'error');
                return;
            }
            
            try {
                const withdrawBtn = document.getElementById('withdrawBtn');
                withdrawBtn.disabled = true;
                withdrawBtn.textContent = '‚è≥ Estimating Gas...';
                
                // Estimate gas for token transfer
                const estimatedGas = 65000; // Approximate for ERC20 transfer
                const gasPrice = await web3.eth.getGasPrice();
                const gasCost = web3.utils.fromWei((BigInt(estimatedGas) * BigInt(gasPrice)).toString(), 'ether');
                
                document.getElementById('withdrawGasInfo').innerHTML = `
                    Estimated Gas: ${estimatedGas.toLocaleString()} units<br>
                    Gas Price: ${web3.utils.fromWei(gasPrice, 'gwei')} Gwei<br>
                    Estimated Cost: ~${parseFloat(gasCost).toFixed(6)} ETH<br>
                    Sending: ${amount} MTK to ${recipient.substring(0, 10)}...
                `;
                
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = `üè¶ Withdraw ${amount} MTK`;
                withdrawBtn.onclick = () => withdrawTokens();
                
                showNotification('Withdrawal gas estimated!', 'success');
                
            } catch (error) {
                showNotification('Gas estimation failed: ' + error.message, 'error');
                document.getElementById('withdrawBtn').disabled = false;
                document.getElementById('withdrawBtn').textContent = 'üè¶ Withdraw MTK';
            }
        }

        async function withdrawTokens() {
            const amountInput = document.getElementById('withdrawAmount');
            const amount = parseFloat(amountInput.value);
            const recipient = document.getElementById('recipientAddress').value;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (!recipient || !recipient.startsWith('0x')) {
                showNotification('Please enter a valid recipient address', 'error');
                return;
            }
            
            if (walletBalance < amount) {
                showNotification(`Insufficient balance! You have ${walletBalance} MTK`, 'error');
                return;
            }
            
            try {
                showPendingOverlay('Withdrawing MTK tokens...');
                
                // In a real implementation, this would call the transfer function
                if (mtkContract && mtkContract.methods.transfer) {
                    // Real blockchain transaction
                    const decimals = await mtkContract.methods.decimals().call();
                    const amountInWei = web3.utils.toWei(amount.toString(), 'ether');
                    
                    const tx = await mtkContract.methods.transfer(
                        recipient, 
                        amountInWei
                    ).send({ 
                        from: userAccount,
                        gas: 100000 
                    });
                    
                    document.getElementById('pendingTxHash').textContent = `Tx Hash: ${tx.transactionHash.substring(0, 20)}...`;
                    
                    // Wait for confirmation
                    const receipt = await web3.eth.getTransactionReceipt(tx.transactionHash);
                    if (receipt.status) {
                        // Update balances
                        walletBalance -= amount;
                        totalWithdrawn += amount;
                        
                        updateUI();
                        hidePendingOverlay();
                        
                        showNotification(`‚úÖ Successfully withdrew ${amount} MTK!`, 'success');
                        
                        document.getElementById('withdrawGasInfo').innerHTML = `
                            ‚úÖ Withdrawal successful!<br>
                            ${amount} MTK sent to ${recipient.substring(0, 10)}...
                        `;
                    }
                } else {
                    // Demo mode - simulate withdrawal
                    const txHash = '0x' + Array.from({length: 64}, () => 
                        Math.floor(Math.random() * 16).toString(16)).join('');
                    
                    document.getElementById('pendingTxHash').textContent = `Tx Hash: ${txHash.substring(0, 20)}...`;
                    
                    setTimeout(() => {
                        walletBalance -= amount;
                        totalWithdrawn += amount;
                        
                        updateUI();
                        hidePendingOverlay();
                        
                        showNotification(`‚úÖ Withdrew ${amount} MTK to ${recipient.substring(0, 10)}...`, 'success');
                        
                        document.getElementById('withdrawGasInfo').innerHTML = `
                            ‚úÖ Withdrawal simulated!<br>
                            ${amount} MTK sent to ${recipient.substring(0, 10)}...
                        `;
                    }, 3000);
                }
                
                // Reset withdraw button
                const withdrawBtn = document.getElementById('withdrawBtn');
                withdrawBtn.textContent = 'üè¶ Withdraw MTK';
                withdrawBtn.onclick = () => estimateWithdrawGas();
                
            } catch (error) {
                hidePendingOverlay();
                showNotification('Withdrawal failed: ' + error.message, 'error');
                
                const withdrawBtn = document.getElementById('withdrawBtn');
                withdrawBtn.textContent = 'üè¶ Withdraw MTK';
                withdrawBtn.onclick = () => estimateWithdrawGas();
            }
        }

        // ====================
        // WALLET FUNCTIONS
        // ====================
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showNotification('Please install MetaMask first!', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length === 0) {
                    showNotification('Please unlock MetaMask and try again', 'error');
                    return;
                }
                
                web3 = new Web3(window.ethereum);
                userAccount = accounts[0];
                
                // Initialize contract
                mtkContract = new web3.eth.Contract(MTK_CONTRACT_ABI, MTK_CONTRACT_ADDRESS);
                
                const chainId = await web3.eth.getChainId();
                
                if (chainId !== 11155111) {
                    showNotification('Please switch to Sepolia Testnet', 'warning');
                    return;
                }
                
                // Update UI
                document.getElementById('accountAddress').textContent = 
                    `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
                
                connected = true;
                
                // Switch to game screen
                document.getElementById('connectionScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                
                // Initialize game
                initGame();
                
                // Load balances
                await refreshBalances();
                
                showNotification('‚úÖ Wallet connected successfully!', 'success');
                
            } catch (error) {
                showNotification('Connection failed: ' + error.message, 'error');
            }
        }

        async function refreshBalances() {
            if (!connected || !web3) return;
            
            try {
                // Get ETH balance
                const ethBalance = await web3.eth.getBalance(userAccount);
                const ethFormatted = web3.utils.fromWei(ethBalance, 'ether');
                document.getElementById('ethBalance').textContent = 
                    `${parseFloat(ethFormatted).toFixed(4)} ETH`;
                
                // Get MTK token balance if contract is deployed
                if (mtkContract && mtkContract.methods.balanceOf) {
                    try {
                        const tokenBalance = await mtkContract.methods.balanceOf(userAccount).call();
                        const decimals = await mtkContract.methods.decimals().call();
                        const tokenName = await mtkContract.methods.name().call();
                        
                        const formattedBalance = tokenBalance / Math.pow(10, decimals);
                        walletBalance = formattedBalance;
                        
                        updateUI();
                    } catch (error) {
                        console.log('Token balance check failed, using demo mode');
                    }
                }
                
                showNotification('Balances refreshed!', 'success');
                
            } catch (error) {
                console.error('Balance refresh error:', error);
            }
        }

        function disconnectWallet() {
            connected = false;
            web3 = null;
            userAccount = null;
            mtkContract = null;
            
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('connectionScreen').classList.remove('hidden');
            
            showNotification('Wallet disconnected', 'info');
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('gameBalance').textContent = `${score} MTK`;
            document.getElementById('claimableAmount').textContent = `${claimableBalance} MTK`;
            document.getElementById('walletBalance').textContent = `${walletBalance} MTK`;
            document.getElementById('totalMined').textContent = `${totalMined} MTK`;
            document.getElementById('totalClaimed').textContent = `${totalClaimed} MTK`;
            document.getElementById('totalWithdrawn').textContent = `${totalWithdrawn} MTK`;
            document.getElementById('multiplier').textContent = `${miningPower}x`;
            document.getElementById('miners').textContent = miners;
            document.getElementById('speed').textContent = miningSpeed.toFixed(1);
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function showPendingOverlay(message) {
            document.getElementById('pendingText').textContent = message;
            document.getElementById('pendingOverlay').classList.remove('hidden');
            
            if (web3) {
                web3.eth.getGasPrice().then(price => {
                    document.getElementById('pendingGasInfo').textContent = 
                        `Gas Price: ${web3.utils.fromWei(price, 'gwei')} Gwei`;
                });
            }
        }

        function hidePendingOverlay() {
            document.getElementById('pendingOverlay').classList.add('hidden');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            const colors = {
                'error': '#ff4757',
                'success': '#2ed573',
                'warning': '#ffa502',
                'info': '#1e90ff'
            };
            
            notification.style.background = colors[type] || '#f8c555';
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Initialize
        window.onload = function() {
            // Check if already connected to MetaMask
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            document.getElementById('connectionScreen').classList.add('hidden');
                            document.getElementById('gameScreen').classList.remove('hidden');
                            connectWallet();
                        }
                    });
            }
        };
    </script>
    
    <!-- Include Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
</body>
</html>
